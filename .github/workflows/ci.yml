---
# =====================================================================
# üöÄ CI - Integra√ß√£o Cont√≠nua do QA Or√°culo
# ---------------------------------------------------------------------
# Este workflow √© executado automaticamente em todo push ou pull request.
# Ele garante a qualidade do c√≥digo antes de ser fundido na branch main.
#
# O que ele faz:
# 1. Verifica se o c√≥digo segue PEP8 usando o Black.
# 2. Roda o Ruff (lint) para detectar m√°s pr√°ticas, imports e bugs comuns.
# 3. Executa todos os testes unit√°rios com pytest.
# 4. Gera relat√≥rio de cobertura de testes.
# 5. Falha o pipeline se a cobertura for menor que 90%.
# =====================================================================

name: CI

# ---------------------------------------------------------------------
# üîî Gatilhos de execu√ß√£o
# Executa este workflow quando:
# - houver push na branch main
# - ou quando um Pull Request for aberto para main
# ---------------------------------------------------------------------
on:
  pull_request: {}
  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      python_version:
        description: "Vers√£o do Python a ser testada (opcional)"
        required: false
        default: "3.12"
# ---------------------------------------------------------------------
# üë∑ Defini√ß√£o dos jobs (etapas)
# Cada job roda em um ambiente isolado (VM Linux no GitHub).
# ---------------------------------------------------------------------
jobs:
  test:
    runs-on: ubuntu-latest  # sistema operacional do runner

    # -----------------------------------------------------------------
    # Estrat√©gia de matriz ‚Üí roda o mesmo job em v√°rias vers√µes do Python
    # Isso garante compatibilidade futura do projeto.
    # -----------------------------------------------------------------
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      # ---------------------------------------------------------------
      # 1Ô∏è‚É£ Baixa o c√≥digo do reposit√≥rio para dentro do runner
      # ---------------------------------------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2Ô∏è‚É£ Configura o Python na vers√£o especificada na matriz
      # ---------------------------------------------------------------
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # ---------------------------------------------------------------
      # 3Ô∏è‚É£ Cache das depend√™ncias pip
      # Se requirements.txt n√£o mudou, reaproveita pacotes j√° instalados
      # ---------------------------------------------------------------
      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}

      # ---------------------------------------------------------------
      # 4Ô∏è‚É£ Instala depend√™ncias do projeto e ferramentas de qualidade
      # ---------------------------------------------------------------
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff pytest pytest-cov pytest-benchmark

      # ---------------------------------------------------------------
      # 5Ô∏è‚É£ Verifica formata√ß√£o com Black
      # Se algum arquivo n√£o estiver no padr√£o, o job falha
      # ---------------------------------------------------------------
      - name: Lint (Black check)
        run: black --check .

      # ---------------------------------------------------------------
      # 6Ô∏è‚É£ Analisa m√°s pr√°ticas com Ruff (lint)
      # ---------------------------------------------------------------
      - name: Lint (Ruff)
        run: ruff check .

      # ---------------------------------------------------------------
      # 7Ô∏è‚É£ Executa testes e gera relat√≥rio de cobertura em XML
      # ---------------------------------------------------------------
      - name: Run tests + coverage (XML + fail-under)
        run: |
          pytest \
            --cov=qa_core \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=90

  # -----------------------------------------------------------------
  # üöÄ Performance Benchmarks
  # Executa testes de performance e detecta regress√µes
  # -----------------------------------------------------------------
  performance:
    runs-on: ubuntu-latest
    # S√≥ executa em PRs para main ou pushes na main
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para comparar com baseline

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}

      - name: Install deps + benchmark
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run performance benchmarks
        run: |
          pytest tests/performance/ \
            --benchmark-only \
            --benchmark-json=benchmark-results.json \
            -v

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tool: 'pytest'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Alerta se performance degradar mais de 20%
          alert-threshold: '120%'
          comment-on-alert: true
          fail-on-alert: false

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.json

  # -----------------------------------------------------------------
  # üîí Secret Scanning
  # Detecta secrets, API keys e credenciais vazadas no c√≥digo
  # -----------------------------------------------------------------
  secret-scan:
    runs-on: ubuntu-latest
    # Executa em todos os eventos (push, PR, workflow_dispatch)
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para escanear todo o hist√≥rico

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

---
# =====================================================================
# üöÄ Release Autom√°tico - QA Or√°culo
# ---------------------------------------------------------------------
# Este workflow automatiza o processo de release usando conventional commits.
#
# O que ele faz:
# 1. Analisa commits desde a √∫ltima release
# 2. Determina a pr√≥xima vers√£o (major/minor/patch) baseado em conventional commits
# 3. Gera changelog automaticamente
# 4. Cria tag e release no GitHub
# 5. Atualiza CHANGELOG.md no reposit√≥rio
# =====================================================================

name: Release

# ---------------------------------------------------------------------
# üîî Gatilhos de execu√ß√£o
# Executa quando:
# - houver push na branch main (ap√≥s merge de PR)
# - ou manualmente via workflow_dispatch
# ---------------------------------------------------------------------
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Tipo de release (major/minor/patch)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - major
          - minor
          - patch

# ---------------------------------------------------------------------
# üë∑ Job de Release
# ---------------------------------------------------------------------
jobs:
  release:
    runs-on: ubuntu-latest
    # S√≥ executa se n√£o for um commit de release (evita loop)
    if: ${{ !contains(github.event.head_commit.message, 'chore(release):') }}

    steps:
      # ---------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout do c√≥digo com hist√≥rico completo
      # ---------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para analisar hist√≥rico de commits
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------
      # 2Ô∏è‚É£ Configura Node.js para semantic-release
      # ---------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------------------------------------------------------------
      # 3Ô∏è‚É£ Instala semantic-release e plugins
      # ---------------------------------------------------------------
      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@^22 \
            @semantic-release/changelog@^6 \
            @semantic-release/git@^10 \
            @semantic-release/github@^9 \
            conventional-changelog-conventionalcommits@^7

      # ---------------------------------------------------------------
      # 4Ô∏è‚É£ Configura Git para commits autom√°ticos
      # ---------------------------------------------------------------
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ---------------------------------------------------------------
      # 5Ô∏è‚É£ Executa semantic-release
      # Analisa commits, determina vers√£o, gera changelog e cria release
      # ---------------------------------------------------------------
      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release

      # ---------------------------------------------------------------
      # 6Ô∏è‚É£ Upload do changelog atualizado como artefato
      # ---------------------------------------------------------------
      - name: Upload changelog
        if: success()
        uses: actions/upload-artifact@v5
        with:
          name: changelog
          path: docs/CHANGELOG.md

# ---------------------------------------------------------------------
# üìù Notas sobre Conventional Commits
# ---------------------------------------------------------------------
# Este workflow usa conventional commits para determinar a vers√£o:
#
# - feat: nova funcionalidade ‚Üí MINOR version bump (1.0.0 ‚Üí 1.1.0)
# - fix: corre√ß√£o de bug ‚Üí PATCH version bump (1.0.0 ‚Üí 1.0.1)
# - BREAKING CHANGE: mudan√ßa incompat√≠vel ‚Üí MAJOR version bump (1.0.0 ‚Üí 2.0.0)
# - chore/docs/style/refactor: sem bump de vers√£o
#
# Exemplos:
# - "feat: adicionar exporta√ß√£o para Postman" ‚Üí 1.0.0 ‚Üí 1.1.0
# - "fix: corrigir erro na valida√ß√£o de US" ‚Üí 1.0.0 ‚Üí 1.0.1
# - "feat!: remover suporte a Python 3.10" ‚Üí 1.0.0 ‚Üí 2.0.0
# ---------------------------------------------------------------------
